<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shift Reduce Parser</title>
    <link href=favicon.ico? rel="shortcut icon" type=image/x-icon>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<!--<h1>Shift Reduce Parser</h1>-->
<img alt="Shift Reduce Parser!" height="auto" src="logo.png"
     width="35%"/>
<marquee direction="left"><p>CSC 4101 Honors Option</p></marquee>

<div class="container">

    <table border="1" id="parser" style="
    width: 500px;
    height: 300px;">
        <caption>Parser Table</caption>
        <tr>
            <th colspan="1" scope="colgroup"></th>
            <th colspan="6" scope="colgroup">Action</th>
            <th colspan="3" scope="colgroup">Goto</th>

        </tr>
        <tbody>
        <tr>
            <th scope="row">State</th>
            <td>id</td>
            <td>+</td>
            <td>*</td>
            <td>(</td>
            <td>)</td>
            <td>$</td>
            <td>E</td>
            <td>T</td>
            <td>F</td>
        </tr>
        <tr>
            <th scope="row">0</th>
            <td>S5</td>
            <td></td>
            <td></td>
            <td>S4</td>
            <td></td>
            <td></td>
            <td>1</td>
            <td>2</td>
            <td>3</td>
        </tr>
        <tr>
            <th scope="row">1</th>
            <td></td>
            <td>S6</td>
            <td></td>
            <td></td>
            <td></td>
            <td>accept</td>
            <td></td>
            <td></td>
            <td></td>

        </tr>
        <tr>
            <th scope="row">2</th>
            <td></td>
            <td>R2</td>
            <td>S7</td>
            <td></td>
            <td>R2</td>
            <td>R2</td>
            <td></td>
            <td></td>
            <td></td>

        </tr>
        <tr>
            <th scope="row">3</th>
            <td></td>
            <td>R4</td>
            <td>R4</td>
            <td></td>
            <td>R4</td>
            <td>R4</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <th scope="row">4</th>
            <td>S5</td>
            <td></td>
            <td></td>
            <td>S4</td>
            <td></td>
            <td></td>
            <td>8</td>
            <td>2</td>
            <td>3</td>
        </tr>
        <tr>
            <th scope="row">5</th>
            <td></td>
            <td>R6</td>
            <td>R6</td>
            <td></td>
            <td>R6</td>
            <td>R6</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <th scope="row">6</th>
            <td>S5</td>
            <td></td>
            <td></td>
            <td>S4</td>
            <td></td>
            <td></td>
            <td></td>
            <td>9</td>
            <td>3</td>
        </tr>
        <tr>
            <th scope="row">7</th>
            <td>S5</td>
            <td></td>
            <td></td>
            <td>S4</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td>10</td>
        </tr>
        <tr>
            <th scope="row">8</th>
            <td></td>
            <td>S6</td>
            <td></td>
            <td></td>
            <td>S11</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <th scope="row">9</th>
            <td></td>
            <td>R1</td>
            <td>S7</td>
            <td></td>
            <td>R1</td>
            <td>R1</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <th scope="row">10</th>
            <td></td>
            <td>R3</td>
            <td>R3</td>
            <td></td>
            <td>R3</td>
            <td>R3</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <th scope="row">11</th>
            <td></td>
            <td>R5</td>
            <td>R5</td>
            <td></td>
            <td>R5</td>
            <td>R5</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>

        </tbody>
    </table>


    <div style="border: 1px solid black; width: 300px;">
        <p style="margin-left: 15px">
            Grammar<br><br>
            1.E→E +T <br>
            2. E → T <br>
            3. T → T * F <br>
            4. T → F <br>
            5. F → (E) <br>
            6. F → id </p>
    </div>

</div>

<div class="container">

    <table border="1" id="output" style="
    width: 200px;">
        <caption>Output</caption>
    </table>

    <input type="text" id="expression" name="expression" placeholder="Enter an expression..." value="id + ( id * id ) $">
    <button onclick="step()" id="step">Step</button>

</div>

<script>

    function getAction(expression) {
        console.log("getting action from" + expression);
        if (expression.substring(0, 2) === "id") {
            return [1,"id"];
        }

        console.log("ugh");

        switch (expression.substring(0, 1)) {
            case "+":
                console.log("2!");
                return [2,"+"];
            case "*":
                console.log("3!");
                return [3,"*"];
            case "(":
                console.log("4!");
                return [4,"("];
            case ")":
                console.log("5!");
                return [5,")"];
            case "$":
                console.log("6!");
                return [6,"$"];
            case "E":
                console.log("7!");
                return [7,"E"];
            case "T":
                console.log("8!");
                return [8,"T"];
            case "F":
                console.log("9!");
                return [9,"F"];
            default:
                console.log("Error, param \"" + expression.substring(0, 1) + "\" is invalid.");
        }

        return -1;
    }

    function getState(parsed) {
        if (parsed.substring(parsed.length - 2, parsed.length) === "11") {
            console.log("State eleven");
            return 11;
        } else if (parsed.substring(parsed.length - 2, parsed.length) === "10") {
            console.log("State ten");
            return 10;
        }

        console.log("Single digit state: " + parsed.substring(parsed.length - 1, parsed.length));
        return Number(parsed.substring(parsed.length - 1, parsed.length));
    }

    function getFromTable(expression, parsed) {
        document.getElementById('parser').style.backgroundColor = '#FFFFFF';
        const action = getAction(expression)[0];
        const state = getState(parsed.join(""));

        console.log("Grabbing from table. State: " + state + ". Action: " + action + ".");

        document.getElementById('parser').rows[state + 2].cells[action].style.backgroundColor = '#003F87';
        return document.getElementById('parser').rows[state + 2].cells[action].textContent;


    }

    function shift(parsed,expression,number){
        const action = getAction(expression)[1];

        console.log("Shifted: " +parsed + action+number);

        parsed = [getAction(expression)[1],number];

        expression = expression.substring(action.length+1);

        return [parsed,expression];
    }

    function replaceItem(parsed,newElement,oldElement){
        console.log("Replacing " + oldElement + " with " + newElement + " within " + parsed);
        for(let i = parsed.length; i > oldElement.length; i--){
            if(parsed.substring(i-oldElement.length,i)===oldElement){
                return parsed.substring(0,i-oldElement.length)+newElement;
            }
        }
        return "error";
    }


    function grammerReplacement(grammar){
        console.log("Grammar evaluated: " + grammar);
        //console.log("parsed: " + parsed);

        switch (grammar)
        {
            case "1":
                return ["E","+"];
            case "2":
                return ["E",""];
            case "3":
                return ["T","*"];
            case "4":
                return ["T",""];
            case "5":
                return ["F","("];
            case "6":
                return ["F",""];
        }
    }

    function reduce(parsed,expression,number){


        let newItem;
        let itemReplace;

        [newItem, itemReplace] = grammerReplacement(number);

        if(itemReplace===""){
            parsed[parsed.length-2] = newItem;
        } else {
           console.log("\n\nSpecial case!")
            console.log("Looking for " + itemReplace);
            for(let i = parsed.length; i >=0; i--){
                console.log("Evaluating " + parsed[i]);
               if(parsed[i]===itemReplace){
                   console.log(itemReplace + " found at position " + i);
                   parsed = parsed.slice(0,i);
                   if(itemReplace==="("){
                       parsed[parsed.length] = "F";
                       parsed[parsed.length] = "-1";//TODO fix this patch
                   }
                   i=-1;
               }
            }
        }


        switch (parsed[parsed.length-2]){
            case "E":
                console.log("E!");
                console.log(parseInt(parseInt(parsed[parsed.length-3])) + 2);
                parsed[parsed.length-1]=document.getElementById('parser').rows[parseInt(parsed[parsed.length-3]) + 2].cells[7].textContent;
                break;
            case "T":
                console.log("T!");
                console.log(parseInt(parseInt(parsed[parsed.length-3])) + 2);
                parsed[parsed.length-1]=document.getElementById('parser').rows[parseInt(parsed[parsed.length-3]) + 2].cells[8].textContent;
                break;
            case "F":
                console.log("F!");
                parsed[parsed.length-1]=document.getElementById('parser').rows[parseInt(parsed[parsed.length-3]) + 2].cells[9].textContent;
                break;
        }

        //parsed = grammerReplacement(number, parsed);



        return parsed;
    }


    function parse(parsed, expression) {


        const element = getFromTable(expression, parsed);

        console.log("The element: "+ element);

        if (element === "accept") {
            console.log("Finished");
        } else if (element.substring(0, 1) === "S") {
            console.log("Shifting");
            let arrToAdd;
            [arrToAdd, expression] = shift(parsed,expression,element.substring(1, element.length));
            parsed = parsed.concat(arrToAdd);

        } else if (element.substring(0, 1) === "R") {
            console.log("Reducing");
            parsed = reduce(parsed,expression,element.substring(1, element.length));
        } else {
            console.log("Grammar");
            parsed = getGrammar(Number(element), parsed)[0];
        }


        return [parsed, expression];
    }

    function insertItem(table, element1, element2) {
        const row = table.insertRow(-1);
        const col1 = row.insertCell(0);
        const col2 = row.insertCell(1);
        col1.innerHTML = element1;
        col2.innerHTML = element2;
    }


    function step() {
        console.log("\n\n\nBEGIN NEXT PARSE");


        const table = document.getElementById("output");

        let parsedArray = [];
        if (sessionStorage.getItem("parsedArray")) {
            parsedArray = JSON.parse(sessionStorage.getItem("parsedArray"));
        }



        if (table.rows.length === 0) {
            insertItem(table, "0", document.getElementById("expression").value)
            parsedArray = [0];


        } else {
            console.log("Parsed array is now " + parsedArray);
            var expression = table.rows[table.rows.length - 1].cells[1].innerHTML;
            [parsedArray, expression] = parse(parsedArray, expression)

            if(parsedArray.join("")==="0E1" && expression==="$"){
                document.getElementById("step").disabled = true;
            }

            insertItem(table, parsedArray.join(""), expression)

        }

        sessionStorage.setItem("parsedArray", JSON.stringify(parsedArray));


    }

</script>


</body>
</html>
